<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalyst Ridge Advisory Â· HTML Publisher</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --teal: #0E5E6F;
      --teal-dark: #0B4B59;
      --coral: #FF6B5A;
      --sky: #A8DADC;
      --slate: #2E3A46;
      --ink: #102027;
      --white: #F8F9FA;

      --border: rgba(46,58,70,0.16);
      --shadow-lg: 0 24px 60px rgba(16,32,39,0.14);
      --shadow-md: 0 14px 34px rgba(16,32,39,0.10);

      --radius-lg: 18px;
      --radius-md: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --heading: "Montserrat", system-ui, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 28px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--slate);
      min-height: 100vh;

      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(168,218,220,0.45), transparent 60%),
        radial-gradient(900px 600px at 90% 15%, rgba(255,107,90,0.22), transparent 55%),
        linear-gradient(135deg, rgba(14,94,111,0.10), rgba(168,218,220,0.18)),
        var(--white);
    }

    .container { max-width: 1180px; margin: 0 auto; }

    header {
      display:flex; align-items:center; justify-content:space-between;
      gap: 18px; margin-bottom: 18px;
    }

    .brand { display:flex; align-items:center; gap: 14px; }

    .brand-text { display:flex; flex-direction:column; line-height:1.1; }

    .brand-title {
      font-family: var(--heading);
      font-weight: 900;
      font-size: 18px;
      color: var(--teal);
      letter-spacing: 0.2px;
    }

    .brand-sub {
      font-size: 12px;
      color: rgba(46,58,70,0.75);
      margin-top: 2px;
    }

    .topbar-right {
      display:flex; align-items:center; gap: 10px;
      flex-wrap: wrap; justify-content:flex-end;
    }

    .pill {
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(14,94,111,0.25);
      background: rgba(168,218,220,0.28);
      color: var(--teal);
      font-size: 12px;
      font-weight: 700;
    }

    .who { font-size: 12px; color: rgba(46,58,70,0.70); }

    h1 {
      font-family: var(--heading);
      font-size: 22px;
      font-weight: 900;
      margin: 0;
      color: var(--teal-dark);
    }

    .sub { margin-top: 6px; font-size: 13px; color: rgba(46,58,70,0.75); }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1.15fr;
      gap: 16px;
      margin-top: 14px;
    }

    @media (max-width: 900px) {
      body { padding: 18px; }
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(248,249,250,0.90);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 18px;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(8px);
    }

    label {
      display:block;
      font-size: 12px;
      font-weight: 700;
      color: rgba(46,58,70,0.85);
      margin-bottom: 6px;
    }

    input[type="text"] {
      width:100%;
      padding: 11px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(46,58,70,0.22);
      background: rgba(248,249,250,0.98);
      color: var(--ink);
      outline: none;
      font-family: var(--mono);
      font-size: 13px;
    }

    textarea {
      width:100%;
      min-height: 420px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(46,58,70,0.22);
      background: rgba(248,249,250,0.98);
      color: var(--ink);
      outline: none;
      resize: vertical;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.45;
    }

    input[type="text"]:focus,
    textarea:focus {
      border-color: rgba(14,94,111,0.55);
      box-shadow: 0 0 0 4px rgba(168,218,220,0.35);
    }

    .rowline { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top: 12px; }

    .check {
      display:inline-flex; align-items:center; gap:8px;
      font-size: 13px; font-weight: 600;
      color: rgba(46,58,70,0.75);
    }

    button {
      appearance:none;
      border-radius: 14px;
      padding: 10px 14px;
      border: 1px solid rgba(46,58,70,0.22);
      background: rgba(248,249,250,0.95);
      color: var(--slate);
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      transition: transform 0.05s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    button:hover { border-color: rgba(14,94,111,0.45); box-shadow: var(--shadow-md); }
    button:active { transform: translateY(1px); }

    button.primary {
      border-color: rgba(14,94,111,0.55);
      background: linear-gradient(135deg, rgba(14,94,111,0.14), rgba(168,218,220,0.36));
      color: var(--teal-dark);
    }

    button:disabled { opacity: 0.55; cursor: not-allowed; box-shadow:none; }

    .notice {
      margin-top: 14px;
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid rgba(46,58,70,0.18);
      background: rgba(248,249,250,0.98);
      white-space: pre-wrap;
      font-size: 13px;
      display:none;
    }

    .notice.ok {
      display:block;
      border-color: rgba(14,94,111,0.35);
      background: rgba(168,218,220,0.28);
      color: var(--teal-dark);
      font-weight: 700;
    }

    .notice.err {
      display:block;
      border-color: rgba(255,107,90,0.35);
      background: rgba(255,107,90,0.14);
      color: #8B2D24;
      font-weight: 700;
    }

    .notice.info { display:block; color: rgba(46,58,70,0.75); }

    .mutedHint { margin-top: 10px; font-size: 13px; color: rgba(46,58,70,0.70); }

    .section-gap { height: 16px; }

    .listHeader { display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom: 10px; }

    .listHeader h2 {
      font-family: var(--heading);
      font-size: 16px;
      font-weight: 900;
      color: var(--teal);
      margin: 0;
    }

    #listStatus { font-size: 13px; color: rgba(46,58,70,0.72); margin-top: 6px; }

    .listWrap { display:grid; gap:10px; margin-top: 12px; }

    .row {
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(46,58,70,0.16);
      background: rgba(248,249,250,0.94);
      box-shadow: 0 10px 26px rgba(16,32,39,0.08);
    }

    .rowLeft {
      display:flex;
      align-items:flex-start;
      gap: 10px;
      min-width: 0;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-top: 6px;
      flex: 0 0 auto;
      border: 1px solid rgba(16,32,39,0.18);
      box-shadow: 0 6px 14px rgba(16,32,39,0.10);
    }
    .dot.green { background: rgba(46, 184, 92, 0.95); }
    .dot.yellow { background: rgba(245, 196, 66, 0.98); }
    .dot.red { background: rgba(255, 107, 90, 0.95); }

    .rowText {
      min-width: 0;
    }

    .rowName {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--ink);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 620px;
      font-weight: 800;
    }

    .rowMeta {
      margin-top: 4px;
      font-size: 12px;
      color: rgba(46,58,70,0.72);
    }

    .rowActions { display:inline-flex; align-items:center; gap:10px; flex-shrink:0; }

    a.viewBtn {
      color: var(--teal-dark);
      text-decoration:none;
      font-weight: 900;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(14,94,111,0.22);
      background: rgba(168,218,220,0.22);
    }

    a.viewBtn:hover {
      border-color: rgba(14,94,111,0.40);
      background: rgba(168,218,220,0.30);
    }

    .trash {
      width: 44px;
      height: 38px;
      padding: 0;
      border-radius: 14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border: 1px solid rgba(255,107,90,0.45);
      background: rgba(255,107,90,0.12);
      color: #8B2D24;
    }

    /* gated UI */
    #app { display:none; }
    #gate { display:block; margin-top: 14px; }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="brand-text">
          <div class="brand-title">Catalyst Ridge Advisory</div>
          <div class="brand-sub">Internal Publisher Tool</div>
        </div>
      </div>

      <div class="topbar-right">
        <div class="who" id="who">Checking session...</div>
        <div class="who">Path: <span class="pill">/cra/</span></div>
        <button id="logoutBtn" type="button" disabled>Log out</button>
      </div>
    </header>

    <div id="gate" class="card">
      <h1>Checking your session</h1>
      <div class="sub">If you are not signed in, you will be redirected to login.</div>
      <div id="gateNotice" class="notice info">Loading...</div>
    </div>

    <div id="app">
      <h1>HTML Publisher</h1>
      <div class="sub">Publish and manage pages inside <span class="pill">/cra/</span></div>

      <div class="grid">
        <div class="card">
          <label for="slug">Slug or filename</label>
          <input id="slug" type="text" placeholder="example: landing or landing.html" />

          <div class="rowline">
            <label class="check">
              <input id="overwrite" type="checkbox" />
              Overwrite if exists
            </label>

            <button id="publishBtn" class="primary" type="button">Publish</button>
            <button id="clearBtn" type="button">Clear</button>
            <button id="refreshBtn" type="button">Refresh list</button>
          </div>

          <div id="notice" class="notice info"></div>

          <div class="mutedHint">
            Dot status: yellow means publishing, green means published, red means failed.
          </div>
        </div>

        <div class="card">
          <label for="html">HTML</label>
          <textarea id="html" placeholder="Paste HTML here..."></textarea>
        </div>
      </div>

      <div class="section-gap"></div>

      <div class="card">
        <div class="listHeader">
          <div>
            <h2>Published pages</h2>
            <div id="listStatus"></div>
          </div>
        </div>

        <div id="list" class="listWrap"></div>
      </div>
    </div>
  </div>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    function $(id) { return document.getElementById(id); }

    // Session-scoped status cache:
    // slug -> { state: "yellow"|"green"|"red", at: epochMs, msg?: string }
    const statusBySlug = new Map();

    function nowMs() { return Date.now(); }

    function formatWhen(epochMs) {
      if (!epochMs) return "";
      const diff = nowMs() - epochMs;
      const s = Math.floor(diff / 1000);
      if (s < 10) return "Published just now";
      if (s < 60) return "Published " + s + " sec ago";
      const m = Math.floor(s / 60);
      if (m < 60) return "Published " + m + " min ago";
      const h = Math.floor(m / 60);
      if (h < 24) return "Published " + h + " hr ago";
      const d = new Date(epochMs);
      return "Published " + d.toLocaleString();
    }

    function showGate(msg) {
      $("gateNotice").className = "notice info";
      $("gateNotice").textContent = msg || "Loading...";
    }

    function setNotice(kind, msg) {
      const box = $("notice");
      if (!msg) {
        box.className = "notice info";
        box.textContent = "";
        box.style.display = "none";
        return;
      }
      box.style.display = "block";
      box.textContent = msg;
      box.className = "notice " + (kind === "ok" ? "ok" : kind === "err" ? "err" : "info");
    }

    function normalizeSlug(input) {
      const raw = String(input || "").trim();
      if (!raw) return "";
      if (!raw.includes(".")) return raw + ".html";
      return raw;
    }

    function toLogin(msgKey) {
      const next = window.location.pathname + window.location.search;
      const url = new URL("/admin/login.html", window.location.origin);
      url.searchParams.set("next", next || "/admin/publisher/index.html");
      if (msgKey) url.searchParams.set("msg", msgKey);
      window.location.href = url.toString();
    }

    async function fetchJson(url, options) {
      const res = await fetch(url, options);
      if (res.status === 401) {
        toLogin("session-expired");
        throw new Error("Not authenticated");
      }
      let data;
      try { data = await res.json(); }
      catch { throw new Error("Invalid JSON response"); }
      return { res, data };
    }

    function normalizePagesResponse(data) {
      if (data && data.ok && Array.isArray(data.pages)) {
        return data.pages.map(p => ({
          slug: String(p.slug || "").trim(),
          url: p.url ? String(p.url) : ""
        })).filter(p => p.slug);
      }
      return [];
    }

    function showUser(user) {
      const who = $("who");
      if (!user) { who.textContent = "Not signed in"; return; }
      const email = user.email || "";
      who.textContent = email ? ("Signed in: " + email) : "Signed in";
    }

    function dotFor(slug) {
      const entry = statusBySlug.get(slug);
      if (!entry) return { cls: "green", meta: "" };

      if (entry.state === "yellow") {
        return { cls: "yellow", meta: "Publishing..." };
      }
      if (entry.state === "red") {
        return { cls: "red", meta: entry.msg ? ("Failed: " + entry.msg) : "Failed" };
      }
      // green
      return { cls: "green", meta: formatWhen(entry.at) };
    }

    function renderList(pages) {
      const list = $("list");
      list.innerHTML = "";

      for (const p of pages) {
        const slug = p.slug || "";
        const url = p.url || ("/cra/" + slug);

        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "rowLeft";

        const dot = document.createElement("div");
        const d = dotFor(slug);
        dot.className = "dot " + d.cls;
        dot.title = d.cls === "green" ? "Published" : d.cls === "yellow" ? "Publishing" : "Failed";

        const txt = document.createElement("div");
        txt.className = "rowText";

        const name = document.createElement("div");
        name.className = "rowName";
        name.textContent = slug;

        const meta = document.createElement("div");
        meta.className = "rowMeta";
        meta.textContent = d.meta || "Published";

        txt.appendChild(name);
        txt.appendChild(meta);

        left.appendChild(dot);
        left.appendChild(txt);

        const actions = document.createElement("div");
        actions.className = "rowActions";

        const view = document.createElement("a");
        view.className = "viewBtn";
        view.href = url;
        view.target = "_blank";
        view.rel = "noopener";
        view.textContent = "View";

        const del = document.createElement("button");
        del.className = "trash";
        del.type = "button";
        del.textContent = "ðŸ—‘ï¸";
        del.title = "Delete";

        del.addEventListener("click", async () => {
          const ok = confirm(`Delete /cra/${slug}? This cannot be undone.`);
          if (!ok) return;

          del.disabled = true;
          try {
            const payload2 = await fetchJson("/.netlify/functions/delete-page", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ slug })
            });

            const j = payload2.data;
            if (!j || !j.ok) throw new Error((j && j.error) ? j.error : "Delete failed");

            statusBySlug.delete(slug);
            setNotice("ok", `Deleted: /cra/${slug}`);
            await loadPages();
          } catch (e) {
            setNotice("err", "Delete failed: " + (e && e.message ? e.message : String(e)));
          } finally {
            del.disabled = false;
          }
        });

        actions.appendChild(view);
        actions.appendChild(del);

        row.appendChild(left);
        row.appendChild(actions);

        list.appendChild(row);
      }
    }

    async function loadPages() {
      $("listStatus").textContent = "Loading...";
      $("list").innerHTML = "";
      setNotice("", "");

      let payload;
      try {
        payload = await fetchJson("/.netlify/functions/list-pages", { method: "GET", credentials: "include" });
      } catch (e) {
        $("listStatus").textContent = "Could not load list.";
        setNotice("err", "List failed: " + (e && e.message ? e.message : String(e)));
        return;
      }

      const data = payload.data;
      const pages = normalizePagesResponse(data);

      if (!pages.length) {
        if (data && data.ok === false) {
          $("listStatus").textContent = "List unavailable.";
          setNotice("err", "List failed: " + (data.error ? data.error : "Unknown error"));
          return;
        }
        $("listStatus").textContent = "No pages yet.";
        return;
      }

      // Any slug that exists in the list is "published".
      // If we have it as yellow, flip it to green and keep its timestamp.
      for (const p of pages) {
        const slug = p.slug;
        const entry = statusBySlug.get(slug);
        if (entry && entry.state === "yellow") {
          statusBySlug.set(slug, { state: "green", at: entry.at || nowMs() });
        }
      }

      $("listStatus").textContent = "";
      renderList(pages);
    }

    async function publish() {
      const slug = normalizeSlug($("slug").value);
      $("slug").value = slug;

      if (!slug) { setNotice("err", "Please enter a slug or filename."); return; }

      const html = $("html").value || "";
      if (!html.trim()) { setNotice("err", "Please paste HTML."); return; }

      const overwrite = $("overwrite").checked;

      $("publishBtn").disabled = true;
      setNotice("info", "Publishing...");

      // Mark as in progress immediately (yellow).
      statusBySlug.set(slug, { state: "yellow", at: nowMs() });

      // Best effort: show it in the list immediately if it already exists in DOM
      // by triggering a refresh after setting yellow.
      // If the slug is not in the current list, it'll show as green once the list refresh includes it.
      try {
        const payload = await fetchJson("/.netlify/functions/publish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ slug, html, overwrite })
        });

        const data = payload.data;
        if (!data || !data.ok) throw new Error((data && data.error) ? data.error : "Publish failed");

        const url = data.url || ("/cra/" + slug);
        const commit = data.commit || "(unknown)";
        setNotice("ok", `Published: ${url}\nCommit: ${commit}`);

        // Flip to green now (we will still refresh list to confirm)
        const t = statusBySlug.get(slug);
        statusBySlug.set(slug, { state: "green", at: (t && t.at) ? t.at : nowMs() });

        await loadPages();
        document.querySelector(".listHeader").scrollIntoView({ behavior: "smooth", block: "start" });
      } catch (e) {
        statusBySlug.set(slug, { state: "red", at: nowMs(), msg: (e && e.message) ? e.message : String(e) });
        setNotice("err", "Publish failed: " + (e && e.message ? e.message : String(e)));
        await loadPages();
      } finally {
        $("publishBtn").disabled = false;
      }
    }

    function clearForm() {
      $("slug").value = "";
      $("html").value = "";
      $("overwrite").checked = false;
      setNotice("", "");
    }

    function wireApp() {
      $("publishBtn").addEventListener("click", publish);
      $("clearBtn").addEventListener("click", clearForm);
      $("refreshBtn").addEventListener("click", loadPages);

      loadPages();

      // Refresh timestamps every 20 seconds so "just now" becomes "1 min ago"
      setInterval(() => {
        // re-render if list has content
        if ($("list").children.length > 0) {
          // We do not have the pages array here, so reload list only if you care.
          // Instead, simple approach: trigger loadPages occasionally.
          // This keeps things accurate without complexity.
          loadPages();
        }
      }, 20000);
    }

    function bootAuthGate() {
      if (!window.netlifyIdentity) {
        toLogin("please-login");
        return;
      }

      window.netlifyIdentity.on("init", (user) => {
        if (!user) {
          toLogin("please-login");
          return;
        }

        showUser(user);
        $("logoutBtn").disabled = false;
        $("logoutBtn").addEventListener("click", () => {
          window.netlifyIdentity.logout();
          toLogin("logged-out");
        });

        $("gate").style.display = "none";
        $("app").style.display = "block";

        wireApp();
      });

      window.netlifyIdentity.on("logout", () => toLogin("logged-out"));

      showGate("Loading your session...");
      window.netlifyIdentity.init();
    }

    bootAuthGate();
  </script>
</body>
</html>

